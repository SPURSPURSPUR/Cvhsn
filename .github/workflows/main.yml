name: Multi-Source M3U Synchronizer

on:
  schedule:
    # Jalan setiap 30 menit otomatis
    - cron: '*/30 * * * *' 
  workflow_dispatch: # Tombol manual buat tes

jobs:
  sync-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Izin wajib supaya bisa save file ke repo
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # --- FETCH SUMBER DENGAN TRANSFORMASI WAKTU ---
      
      - name: 2. Fetch BONGDA1 dan Label WIB
        run: |
          # 1. Download file
          curl -sSL "https://raw.githubusercontent.com/t23-02/bongda/main/bongda.m3u" -o "bongda1.m3u" || echo "Gagal BONGDA1"
          
          # 2. Transformasi: Hapus zona waktu asing yang umum (ET, UK, GMT, dll.)
          # Menggunakan sintaks sed yang lebih aman
          sed -i 's/[ ]\(AM\|PM\)\?\s*\(ET\|MT\|UK\|GMT\|UTC\|CET\|BST\|CST\)\(\s*\|)\)//g' bongda1.m3u
          
          # 3. Transformasi: Tambahkan label WIB setelah format jam (HH:MM)
          sed -i 's/\([0-9]\{1,2\}:[0-9]\{2\}\)/\1 WIB/g' bongda1.m3u
          echo "✅ Waktu BONGDA1 dilabeli WIB."

      - name: 3. Fetch BONGDA2 dan Label WIB
        run: |
          curl -sSL "https://raw.githubusercontent.com/t23-02/bongda/main/bongda2.m3u" -o "bongda2.m3u" || echo "Gagal BONGDA2"
          
          # Transformasi: Hapus zona waktu asing
          sed -i 's/[ ]\(AM\|PM\)\?\s*\(ET\|MT\|UK\|GMT\|UTC\|CET\|BST\|CST\)\(\s*\|)\)//g' bongda2.m3u
          
          # Transformasi: Tambahkan label WIB
          sed -i 's/\([0-9]\{1,2\}:[0-9]\{2\}\)/\1 WIB/g' bongda2.m3u
          echo "✅ Waktu BONGDA2 dilabeli WIB."

      - name: 4. Fetch PPV dan Label WIB
        run: |
          curl -sSL "https://raw.githubusercontent.com/felixiptv/FelixLive/main/PPVLand.m3u8" -o "ppv.m3u" || echo "Gagal PPV"
          
          # Transformasi: Hapus zona waktu asing
          sed -i 's/[ ]\(AM\|PM\)\?\s*\(ET\|MT\|UK\|GMT\|UTC\|CET\|BST\|CST\)\(\s*\|)\)//g' ppv.m3u
          
          # Transformasi: Tambahkan label WIB
          sed -i 's/\([0-9]\{1,2\}:[0-9]\{2\}\)/\1 WIB/g' ppv.m3u
          echo "✅ Waktu PPV dilabeli WIB."
          
      - name: 5. Fetch Sony
        run: |
          # Sony tidak diubah karena formatnya mungkin berbeda dan rentan error jika diubah
          curl -sSL -L --connect-timeout 20 "https://sp.networkerror404.top/playlist/sliv.php" -o "sony.m3u" || echo "Gagal Sony"

      # --- PENGGABUNGAN (MERGE) ---
      
      - name: 6. Merge Playlists
        run: |
          FINAL_OUTPUT="final_playlist.m3u"
          
          # Buat Header Baru
          echo "#EXTM3U" > "$FINAL_OUTPUT"
          
          # Fungsi Penggabungan
          append_content() {
              FILENAME=$1
              NAME=$2
              if [ -f "$FILENAME" ]; then
                  echo -e "\n# --- $NAME Playlist Start ---" >> "$FINAL_OUTPUT"
                  tail -n +2 "$FILENAME" >> "$FINAL_OUTPUT"
                  echo "✅ $NAME berhasil digabung."
              else
                  echo "⚠️ File $FILENAME kosong/gagal, dilewati."
              fi
          }

          # Panggil file yang sudah didownload di atas
          append_content "bongda1.m3u" "Bongda 1"
          append_content "bongda2.m3u" "Bongda 2"
          append_content "sony.m3u" "Sony"
          append_content "ppv.m3u" "PPV"

      - name: 7. Clean up Formatting
        run: |
          FINAL_OUTPUT="final_playlist.m3u"
          # Hapus baris kosong
          sed -i '/^$/d' "$FINAL_OUTPUT"
          echo "✅ Format dibersihkan."

      # --- COMMIT PUSH (ACTION KHUSUS) ---
      - name: 8. Commit and Push Changes (Menggunakan Action Khusus)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          files: 'final_playlist.m3u' 
          commit_message: 'Auto-Synced: Playlist Updated (WIB Labeled)'
          token: ${{ secrets.GITHUB_TOKEN }}
          push_options: '--force' 
          
